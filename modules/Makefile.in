#
# Makefile.in for modules
#
# $Id$
#
CC		= @CC@
AR		= @AR@
RM		= @RM@
SED		= @SED@
SEDOBJ		= @SEDOBJ@
STDOUT		= @STDOUT@
CFLAGS		= @IRCSERVICES_CFLAGS@
PICFLAGS	= @PICFLAGS@
MKDEP		= @MKDEP@
INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
MV		= @MV@
LD		= @LD@

SSL_LIBS	= @SSL_LIBS@
SSL_INCLUDES	= @SSL_INCLUDES@
IRCDLIBS        = @LIBS@ $(SSL_LIBS)

prefix          = $(DESTDIR)@prefix@
# Change this later! -- adrian
moduledir       = ${prefix}/modules
automoduledir   = ${moduledir}/autoload

INCLUDES	= -I../include -I../libio $(SSL_INCLUDES)
CPPFLAGS	= ${INCLUDES} @CPPFLAGS@

SRCS =       \
  irc.cc \
	hybridts6.cc \
  oftc.cc \
  nickserv.cc \
  operserv.cc \
  chanserv.cc

ALL_SRCS = $(CORE_SRCS) $(SRCS) @SSL_SRCS_ENABLE@

SH_OBJS = ${SRCS:.cc=.so} luaserv.lua RubyServ.rb
SH_CORE_OBJS = ${CORE_SRCS:.cc=.so}

HPUX_OBJS = ${SH_OBJS:.so=.sl}
HPUX_CORE_OBJS = ${SH_CORE_OBJS:.so=.sl}

S_OBJS = ${ALL_SRCS:.c=.o}

default:	build
build: all
all: .depend @MOD_TARGET@

shared_modules: $(SH_CORE_OBJS) $(SH_OBJS)

hpux_shared: $(SH_CORE_OBJS) $(SH_OBJS) $(HPUX_CORE_OBJS) $(HPUX_OBJS)

libmodules.a: $(S_OBJS)
	$(RM) -f $@
	$(AR) csrv $@ $(S_OBJS) 

install-mkdirs:
	mkdir -p $(prefix)

	-@if test -d $(moduledir)-old; then \
		echo "${RM} -rf $(moduledir)-old"; \
		${RM} -rf $(moduledir)-old; \
	fi
	-@if test -d $(moduledir); then \
		echo "${MV} $(moduledir) $(moduledir)-old"; \
		${MV} $(moduledir) $(moduledir)-old; \
	fi

	mkdir -p $(moduledir) $(automoduledir)
	
install: install_@MOD_TARGET@

install_libmodules.a: libmodules.a
# Ye olde noop here.	

install_shared_modules: install-mkdirs
	@echo "Installing core modules into $(moduledir) .."
	@for file in $(SH_CORE_OBJS); do \
		$(INSTALL_DATA) $$file $(moduledir); \
	done
	@echo "Installing modules into $(automoduledir) .."
	@for file in $(SH_OBJS); do \
		$(INSTALL_DATA) $$file $(automoduledir); \
	done

install_hpux_shared: install-mkdirs
	@echo "Installing core modules into $(moduledir) .."
	@for file in $(HPUX_CORE_OBJS); do \
		$(INSTALL_DATA) $$file $(moduledir); \
	done
	@echo "Installing modules into $(automoduledir) .."
	@for file in $(HPUX_OBJS); do \
		$(INSTALL_DATA) $$file $(automoduledir); \
	done

.SUFFIXES: .sl .so .o

.cc.o:
	${CXX} ${CPPFLAGS} ${CFLAGS} -c $< -o $@

.cc.so:
	${CXX} ${PICFLAGS} ${CPPFLAGS} ${CFLAGS} $< -o $@

.so.sl:
	$(LD) -b $< -o $@

.depend:
	${MKDEP} ${CPPFLAGS} ${ALL_SRCS} ${STDOUT}
	${SED} -e '${SEDOBJ}' < .depend > .depend.tmp-1
	${SED} -e 's/^m_\(server\|squit\|die\|join\|kick\|kill\|message\|mode\|nick\|part\|quit\|sjoin\)/core\/m_\1/' .depend.tmp-1 > .depend.tmp
	@${SED} -e '/^# Autogenerated - do not delete/,$$d' <Makefile >Makefile.depend
	@echo '# Autogenerated - do not delete' >>Makefile.depend
	@echo 'include .depend' >> Makefile.depend
	@${MV} Makefile.depend Makefile
	${MV} -f .depend.tmp .depend
	${RM} -f .depend.tmp-1

clean:
	${RM} -f *.so *.sl *~ *.o *.a so_locations
	${RM} -f core/*.so core/*.sl core/*~ core/*.o

distclean: clean
	${RM} -f Makefile .depend

.PHONY: clean distclean install install_hpux_shared hpux_shared install_shared_modules shared_modules install_libmodules.a install-mkdirs build
